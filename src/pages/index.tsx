import type { NextPage } from 'next'
import Head from 'next/head'
import Link from 'next/link'
import { useSession, signIn, signOut } from 'next-auth/react'
import React, { useCallback, useEffect, useState } from 'react'

interface videos {}

const Home: NextPage = () => {
  const { data: session } = useSession()
  const apikey = String(process.env.NEXT_PUBLIC_YOUTUBE_APIKEY)
  // const apikey = String(process.env.NEXT_PUBLIC_YOUTUBE_APIKEY2)
  const channelID = 'UCBL4qbfyteUA-KGj3_9G1LA'
  const playListUrl = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=UUacLlgUxCnIUegABaDTslyg&maxResults=15&key=${apikey}`

  const [videos, setVideos] = useState<string[]>([''])
  const [word, setWord] = useState<string>('')
  const [searchWord, setSearchWord] = useState<string>('にゃんこ')

  const search_api_url = 'https://www.googleapis.com/youtube/v3/search?'
  // const search_api_url = "https://www.googleapis.com/youtube/v3/channel?"
  useEffect(() => {
    const params = {
      key: apikey,
      q: 'にゃんこ' + searchWord, // 検索ワード
      type: 'video',
      maxResults: '2', // 取得数
      order: 'viewCount', // 再生数順
    }
    const queryParams = new URLSearchParams(params)
    fetch(search_api_url + queryParams)
      .then((res) => res.json())
      .then(
        (result) => {
          console.log('API success:', result)
          if (result.items && result.items.length !== 0) {
            // const firstItem = result.items[0]
            // setVideos(firstItem.id.videoId)
            // console.log('videos', videos)

            const videosId = result.items.map((v, i) => {
              return v.id.videoId
            })
            setVideos(videosId)
          }
        },
        (error) => {
          console.error('err=>', error)
        }
      )
  }, [searchWord, apikey])

  const onSearch = useCallback(
    (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault()
      setSearchWord(word)
    },
    [word]
  )
  const changeWord = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    setWord(e.target.value)
  }, [])

  return (
    <div>
      <Head>
        <title>Create Next App</title>
        <meta name='description' content='Generated by create next app' />
        <link rel='icon' href='/favicon.ico' />
      </Head>

      <header>
        <div className='translate-y-[-5px] slide-left'>
          {session ? (
            <button className='danger-btn' onClick={() => signOut()}>
              LogOut
            </button>
          ) : (
            <button className='primary-btn' onClick={() => signIn()}>
              LogIn
            </button>
          )}
          <div className='float-right'>
            <Link href='/youtubeTest'>test</Link>
            <Link href='/authPage'>authPage</Link>
          </div>
        </div>
      </header>

      <main>
        <div>
          <h1 className='text-red-500 text-[10px]'>
            Welcome to <a href='https://nextjs.org'>Next.js!</a>
          </h1>
          <form onSubmit={(e) => onSearch(e)}>
            <input
              type='text'
              value={word}
              onChange={changeWord}
              className='border border-black'
            />
            <input
              type='submit'
              value='検索'
              className='ml-2 border border-black'
            />
          </form>
          <div onClick={() => setSearchWord('わんこ')}>わんこ</div>
          {videos &&
            videos.map((v, i) => (
              <div key={i}>
                <iframe
                  id='player'
                  width='640'
                  height='360'
                  src={'https://www.youtube.com/embed/' + v}
                  frameBorder='0'
                  allowFullScreen
                />
              </div>
            ))}
          {/* <iframe
            id='player'
            width='640'
            height='360'
            src={'https://www.youtube.com/embed/' + videos}
            // src={'https://www.youtube.com/embed/' + 'oEbtRMeZR24'}
            frameBorder='0'
            allowFullScreen
          /> */}
        </div>
      </main>
      <footer></footer>
    </div>
  )
}

export default Home
